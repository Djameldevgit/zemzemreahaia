import React, { useState, useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import { useHistory, useLocation } from 'react-router-dom';
import { 
  Container, 
  Row, 
  Col, 
  Card, 
  Form, 
  Button, 
  Alert
} from 'react-bootstrap';

// Importar todos los componentes modulares
import CategorySelector from '../components/forms/CategorySelector';
import TitleInput from '../components/forms/TitleInput';
import DescriptionTextarea from '../components/forms/DescriptionTextarea';
import AddressInput from '../components/forms/AddressInput';
import Horariodesalida from '../components/forms/Horariodesalida';
import DurationInput from '../components/forms/DurationInput';
import TransportSelect from '../components/forms/TransportSelect';
import DestinationManager from '../components/forms/DestinationManager';
import PensionSelect from '../components/forms/PensionSelect';
import ReturnDateInput from '../components/forms/ReturnDateInput';
import PriceSlider from '../components/forms/PriceSlider';
import CancellationPolicy from '../components/forms/CancellationPolicy';
import ContactReservation from '../components/forms/ContactReservation';
import ImageUpload from '../components/forms/ImageUpload';

// Importar acciones y tipos
import { createPost, updatePost } from '../redux/actions/postAction';
import communesjson from "../json/communes.json";

const Createpost = () => {
    const { auth, theme, socket } = useSelector((state) => state);
    const dispatch = useDispatch();
    const history = useHistory();
    const location = useLocation();

    // üî∑ OBTENER DATOS DE EDICI√ìN DESDE location.state
    const isEdit = location.state?.isEdit || false;
    const postToEdit = location.state?.postData || null;

    console.log('üöÄ CREATEPOST MOUNTED - Modo:', isEdit ? 'EDICI√ìN' : 'CREACI√ìN');
    console.log('üìç Datos recibidos:', postToEdit);
    console.log('üìç Location state:', location.state);

    // Estado inicial
    const initialState = {
        category: "Agence de Voyage",
        subCategory: "",
        title: "",
        description: "",
        price: "",
        wilaya: "",
        commune: "",
        contacto: "",
        itemsReservations_Visa: "",
        Location_Vacances: '',
        alquilergeneral: "",
        superficie: "",
        etage: "",
        promoteurimmobilier: false,
        specifications: [],
        adress: "",
        nombredelhotel: "",
        adresshotel: "",
        totalhabitaciones: "",
        tipodehabutaciones: [],
        estrellas: "",
        wifi: [],
        language: [],
        tarifnuit: "",
        reservacionenlinea: "",
        politiqueAnnulation: "",
        hotelWebsite: "",
        horariollegada: "",
        horadudepar: "",
        datedepar: "",
        duracionviaje: "",
        transporte: "",
        destinacionvoyage1: "",
        voyage1hotel1: "",
        voyage1nombrehotel1: "",
        destinacionvoyage2: "",
        voyage2hotel2: "",
        voyage1nombrehotel2: "",
        fecharegreso: "",
        serviciosdelhotel: "",
        incluidoenelprecio: "",
        cancelarreserva: "",
        destinacionhadj: "",
    };

    // Estados
    const [postData, setPostData] = useState(initialState);
    const [images, setImages] = useState([]);
    const [selectedWilaya, setSelectedWilaya] = useState("");
    const [showAlert, setShowAlert] = useState(false);
    const [alertMessage, setAlertMessage] = useState("");
    const [alertVariant, setAlertVariant] = useState("info");

    // üî∑ EFFECT PARA CARGAR DATOS DE EDICI√ìN (L√ìGICA QUE FUNCIONA)
    useEffect(() => {
        console.log('üîÑ Effect ejecut√°ndose - isEdit:', isEdit, 'postToEdit:', postToEdit);
        
        if (isEdit && postToEdit) {
            console.log('üéØ Cargando datos para edici√≥n:', postToEdit);
            
            // Cargar datos del post en el estado
            setPostData({
                category: postToEdit.category || "Agence de Voyage",
                subCategory: postToEdit.subCategory || "",
                description: postToEdit.description || postToEdit.content || "",
                title: postToEdit.title || "",
                adress: postToEdit.adress || "",
                price: postToEdit.price || "",
                wilaya: postToEdit.wilaya || "",
                commune: postToEdit.commune || "",
                contacto: postToEdit.contacto || "",
                alquilergeneral: postToEdit.alquilergeneral || "",
                itemsReservations_Visa: postToEdit.itemsReservations_Visa || "",
                Location_Vacances: postToEdit.Location_Vacances || "",
                specifications: postToEdit.specifications || [],
                promoteurimmobilier: postToEdit.promoteurimmobilier || false,
                superficie: postToEdit.superficie || "",
                etage: postToEdit.etage || "",
                nombredelhotel: postToEdit.nombredelhotel || "",
                adresshotel: postToEdit.adresshotel || "",
                totalhabitaciones: postToEdit.totalhabitaciones || "",
                tipodehabutaciones: postToEdit.tipodehabutaciones || [],
                estrellas: postToEdit.estrellas || "",
                wifi: postToEdit.wifi || [],
                language: postToEdit.language || [],
                tarifnuit: postToEdit.tarifnuit || "",
                reservacionenlinea: postToEdit.reservacionenlinea || "",
                politiqueAnnulation: postToEdit.politiqueAnnulation || "",
                hotelWebsite: postToEdit.hotelWebsite || "",
                horariollegada: postToEdit.horariollegada || "",
                horadudepar: postToEdit.horadudepar || "",
                datedepar: postToEdit.datedepar || "",
                duracionviaje: postToEdit.duracionviaje || "",
                transporte: postToEdit.transporte || "",
                destinacionvoyage1: postToEdit.destinacionvoyage1 || "",
                voyage1hotel1: postToEdit.voyage1hotel1 || "",
                voyage1nombrehotel1: postToEdit.voyage1nombrehotel1 || "",
                destinacionvoyage2: postToEdit.destinacionvoyage2 || "",
                voyage2hotel2: postToEdit.voyage2hotel2 || "",
                voyage1nombrehotel2: postToEdit.voyage1nombrehotel2 || "",
                fecharegreso: postToEdit.fecharegreso || "",
                serviciosdelhotel: postToEdit.serviciosdelhotel || "",
                incluidoenelprecio: postToEdit.incluidoenelprecio || "",
                cancelarreserva: postToEdit.cancelarreserva || "",
                destinacionhadj: postToEdit.destinacionhadj || "",
            });

            // Cargar im√°genes
            if (postToEdit.images && postToEdit.images.length > 0) {
                console.log('üñºÔ∏è Cargando im√°genes:', postToEdit.images);
                setImages(postToEdit.images.map(img => ({
                    url: typeof img === 'string' ? img : img.url,
                    file: null // Para im√°genes existentes
                })));
            } else {
                setImages([]);
            }

            setSelectedWilaya(postToEdit.wilaya || "");
        } else {
            // Modo creaci√≥n - resetear a estado inicial
            console.log('üÜï Modo creaci√≥n - Resetear formulario');
            setPostData(initialState);
            setImages([]);
            setSelectedWilaya("");
        }
    }, [isEdit, postToEdit]); // Solo depende de isEdit y postToEdit

    // Handlers para el formulario
    const handleChangeInput = (e) => {
        const { name, value, type, checked } = e.target;
        setPostData(prevState => ({
            ...prevState,
            [name]: type === "checkbox" ? checked : value
        }));
    };

    const handleWilayaChange = (event) => {
        const selectedWilaya = event.target.value;
        setSelectedWilaya(selectedWilaya);
        const wilayaEncontrada = communesjson.find((wilaya) => wilaya.wilaya === selectedWilaya);
        const communes = wilayaEncontrada ? wilayaEncontrada.commune : [];
        
        setPostData((prevState) => ({
            ...prevState,
            wilaya: selectedWilaya,
            commune: communes.length > 0 ? communes[0] : "",
        }));
    };

    const handleCommuneChange = (event) => {
        const selectedCommune = event.target.value;
        setPostData((prevState) => ({
            ...prevState,
            commune: selectedCommune,
        }));
    };

    // Handler para manejar im√°genes (L√ìGICA QUE FUNCIONA)
    const handleChangeImages = (e) => {
        const files = [...e.target.files];
        let err = "";
        let newImages = [];

        files.forEach(file => {
            if (!file) return err = "Le fichier n'existe pas.";

            if (file.size > 1024 * 1024 * 5) { // 5MB limit
                return err = "La taille de l'image/vid√©o ne doit pas d√©passer 5mb.";
            }

            return newImages.push(file);
        });

        if (err) {
            setAlertMessage(err);
            setAlertVariant("danger");
            setShowAlert(true);
            return;
        }

        setImages([...images, ...newImages]);
    };

    // Handler para eliminar im√°genes
    const deleteImages = (index) => {
        const newArr = [...images];
        newArr.splice(index, 1);
        setImages(newArr);
    };

    // üî∑ HANDLER SUBMIT MEJORADO (L√ìGICA QUE FUNCIONA)
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        console.log('üì§ Enviando formulario...', { isEdit, postData, images });

        // Validaciones
        if (!postData.subCategory) {
            setAlertMessage("Veuillez s√©lectionner une cat√©gorie.");
            setAlertVariant("danger");
            setShowAlert(true);
            return;
        }

        if (!postData.wilaya || !postData.commune) {
            setAlertMessage("Veuillez s√©lectionner une wilaya et une commune.");
            setAlertVariant("danger");
            setShowAlert(true);
            return;
        }

        if (images.length === 0) {
            setAlertMessage("Veuillez ajouter au moins une photo ou vid√©o.");
            setAlertVariant("danger");
            setShowAlert(true);
            return;
        }

        try {
            if (isEdit && postToEdit) {
                // üî∑ MODO EDICI√ìN
                console.log('üîÑ Ejecutando updatePost...', { 
                    postId: postToEdit._id, 
                    postData 
                });
                
                // Crear objeto status con el ID del post
                const status = {
                    _id: postToEdit._id,
                    ...postToEdit // Mantener todos los datos originales
                };

                await dispatch(updatePost({ 
                    postData, 
                    images, 
                    auth, 
                    status 
                }));

                setAlertMessage("‚úÖ Annonce mise √† jour avec succ√®s!");
                setAlertVariant("success");
            } else {
                // üî∑ MODO CREACI√ìN
                console.log('üÜï Ejecutando createPost...');
                await dispatch(createPost({ 
                    postData, 
                    images, 
                    auth, 
                    socket 
                }));

                setAlertMessage("‚úÖ Annonce publi√©e avec succ√®s!");
                setAlertVariant("success");
            }

            setShowAlert(true);

            // Redirigir despu√©s de 2 segundos
            setTimeout(() => {
                history.push('/');
            }, 2000);

        } catch (error) {
            console.error('‚ùå Error al enviar:', error);
            setAlertMessage("‚ùå Erreur lors de la publication.");
            setAlertVariant("danger");
            setShowAlert(true);
        }
    };

    // üî∑ HANDLER CANCELAR (L√ìGICA QUE FUNCIONA)
    const handleCancel = () => {
        history.goBack();
    };

    // Opciones para wilayas y communes
    const wilayasOptions = communesjson.map((wilaya, index) => (
        <option key={index} value={wilaya.wilaya}>
            {wilaya.wilaya}
        </option>
    ));

    const communesOptions = selectedWilaya
        ? communesjson
            .find((wilaya) => wilaya.wilaya === selectedWilaya)
            ?.commune?.map((commune, index) => (
                <option key={index} value={commune}>
                    {commune}
                </option>
            ))
        : [];

    return (
        <Container className="my-4">
            <Row className="justify-content-center">
                <Col lg={10}>
                    <Card>
                        <Card.Header className={isEdit ? "bg-warning text-dark" : "bg-primary text-white"}>
                            <h4 className="mb-0">
                                {isEdit ? '‚úèÔ∏è Modifier l\'Annonce' : 'üì¢ Cr√©er une Nouvelle Annonce'}
                            </h4>
                            {isEdit && postToEdit?.title && (
                                <small>Modification: "{postToEdit.title}"</small>
                            )}
                        </Card.Header>
                        <Card.Body>
                            {/* üî∑ DEBUG INFO */}
                            {process.env.NODE_ENV === 'development' && (
                                <Alert variant="info" className="mb-3">
                                    <strong>Debug:</strong> Modo: {isEdit ? 'EDICI√ìN' : 'CREACI√ìN'} | 
                                    ID: {postToEdit?._id || 'N/A'} | 
                                    Categor√≠a: {postData.subCategory || 'No seleccionada'}
                                </Alert>
                            )}

                            {showAlert && (
                                <Alert 
                                    variant={alertVariant} 
                                    dismissible 
                                    onClose={() => setShowAlert(false)}
                                    className="mb-4"
                                >
                                    {alertMessage}
                                </Alert>
                            )}

                            <Form onSubmit={handleSubmit}>
                                
                                {/* Selector de Categor√≠a */}
                                <CategorySelector 
                                    postData={postData} 
                                    handleChangeInput={handleChangeInput} 
                                />

                                {/* Para Viajes Organizados */}
                                {postData.subCategory === "Voyage_Organise" && (
                                    <>
                                        <TitleInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                            placeholder="Ex: Voyage culturel √† Istanbul et Duba√Ø"
                                        />
                                        <DescriptionTextarea 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <AddressInput 
                                            postData={postData}
                                            handleChangeInput={handleChangeInput}
                                            wilayasOptions={wilayasOptions}
                                            communesOptions={communesOptions}
                                            handleWilayaChange={handleWilayaChange}
                                            handleCommuneChange={handleCommuneChange}
                                        />
                                        <Horariodesalida 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <DurationInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <TransportSelect 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <DestinationManager 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <PensionSelect 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <ReturnDateInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <PriceSlider 
                                            postData={postData} 
                                            setPostData={setPostData} 
                                        />
                                        <CancellationPolicy 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <ContactReservation 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                    </>
                                )}

                                {/* Para Location Vacances */}
                                {postData.subCategory === "Location_Vacances" && (
                                    <>
                                        <TitleInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                            placeholder="Ex: Belle villa avec piscine √† Oran"
                                        />
                                        <DescriptionTextarea 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <AddressInput 
                                            postData={postData}
                                            handleChangeInput={handleChangeInput}
                                            wilayasOptions={wilayasOptions}
                                            communesOptions={communesOptions}
                                            handleWilayaChange={handleWilayaChange}
                                            handleCommuneChange={handleCommuneChange}
                                        />
                                        <PriceSlider 
                                            postData={postData} 
                                            setPostData={setPostData} 
                                        />
                                        <ContactReservation 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                    </>
                                )}

                                {/* Para Hadj & Omra */}
                                {postData.subCategory === "hadj_Omra" && (
                                    <>
                                        <TitleInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                            placeholder="Ex: P√®lerinage Hadj 2024 - Package Complet"
                                        />
                                        <DescriptionTextarea 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <AddressInput 
                                            postData={postData}
                                            handleChangeInput={handleChangeInput}
                                            wilayasOptions={wilayasOptions}
                                            communesOptions={communesOptions}
                                            handleWilayaChange={handleWilayaChange}
                                            handleCommuneChange={handleCommuneChange}
                                        />
                                        <Horariodesalida 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <DurationInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <TransportSelect 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <ReturnDateInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <PriceSlider 
                                            postData={postData} 
                                            setPostData={setPostData} 
                                        />
                                        <CancellationPolicy 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <ContactReservation 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                    </>
                                )}

                                {/* Para Reservations & Visa */}
                                {postData.subCategory === "Reservations_Visa" && (
                                    <>
                                        <TitleInput 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                            placeholder="Ex: Assistance Visa Schengen - traitement rapide"
                                        />
                                        <DescriptionTextarea 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                        <AddressInput 
                                            postData={postData}
                                            handleChangeInput={handleChangeInput}
                                            wilayasOptions={wilayasOptions}
                                            communesOptions={communesOptions}
                                            handleWilayaChange={handleWilayaChange}
                                            handleCommuneChange={handleCommuneChange}
                                        />
                                        <PriceSlider 
                                            postData={postData} 
                                            setPostData={setPostData} 
                                        />
                                        <ContactReservation 
                                            postData={postData} 
                                            handleChangeInput={handleChangeInput} 
                                        />
                                    </>
                                )}

                                {/* Componente de im√°genes */}
                                <ImageUpload 
                                    images={images}
                                    handleChangeImages={handleChangeImages}
                                    deleteImages={deleteImages}
                                    theme={theme}
                                />

                                {/* Botones */}
                                <div className="d-flex gap-2 mt-4">
                                    <Button 
                                        variant={isEdit ? "warning" : "success"} 
                                        type="submit" 
                                        size="lg"
                                        className="flex-fill"
                                    >
                                        {isEdit ? 'üíæ Mettre √† jour' : 'üì¢ Publier l\'Annonce'}
                                    </Button>
                                    
                                    <Button 
                                        variant="secondary" 
                                        type="button" 
                                        size="lg"
                                        onClick={handleCancel}
                                    >
                                        ‚ùå Annuler
                                    </Button>
                                </div>
                            </Form>
                        </Card.Body>
                    </Card>
                </Col>
            </Row>
        </Container>
    );
};

export default Createpost;